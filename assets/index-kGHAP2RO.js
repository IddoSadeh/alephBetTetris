(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function l(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(t){if(t.ep)return;t.ep=!0;const a=l(t);fetch(t.href,a)}})();const f=document.getElementById("tetris-canvas"),d=f.getContext("2d",{willReadFrequently:!0}),W=document.getElementById("size"),k=document.getElementById("opacity"),v=document.getElementById("text"),q=document.getElementById("save"),V=document.getElementById("export-format"),$=document.getElementById("font-upload"),E=document.getElementById("font-select"),M=document.querySelectorAll(".pieces-checkbox input[type=checkbox]"),j=document.querySelectorAll(".pieces-checkbox img"),C=document.getElementById("welcome-screen"),_=document.getElementById("close-welcome"),z=document.getElementById("help-button"),T=document.getElementById("saturation"),H=document.getElementById("hue"),O=document.getElementById("luminance");let o={gridWidth:12,gridHeight:12,blockWidth:50,grid:Array.from(Array(12),()=>new Array(12).fill(0)),allowedAreas:Array.from(Array(12),()=>new Array(12).fill(1)),repopulateTimeout:null};function U(){return o.gridWidth=parseInt(W.value),o.gridHeight=parseInt(W.value),o.blockWidth=f.width/o.gridWidth,o.grid=Array.from(Array(o.gridHeight),()=>new Array(o.gridWidth).fill(0)),o.allowedAreas=Array.from(Array(o.gridHeight),()=>new Array(o.gridWidth).fill(1)),new Promise(e=>{d.clearRect(0,0,f.width,f.height),B(),e()})}function F(){const e=k.value/10;return f.style.borderColor=`rgba(255, 255, 255, ${e})`,B(),Promise.resolve()}function b(){const e=T.value,i=H.value,l=O.value,n=`
        saturate(${e}%)
        hue-rotate(${i}deg)
        brightness(${l}%)
    `;f.style.filter=n,j.forEach(t=>{t.style.filter=n})}function B(){d.lineWidth=1;for(let e=0;e<=o.gridWidth;e++)d.beginPath(),d.moveTo(e*o.blockWidth,0),d.lineTo(e*o.blockWidth,f.height),d.strokeStyle="rgba(0, 0, 0, 1)",d.stroke(),d.strokeStyle=`rgba(255, 255, 255, ${k.value/10})`,d.stroke();for(let e=0;e<=o.gridHeight;e++)d.beginPath(),d.moveTo(0,e*o.blockWidth),d.lineTo(f.width,e*o.blockWidth),d.strokeStyle="rgba(0, 0, 0, 1)",d.stroke(),d.strokeStyle=`rgba(255, 255, 255, ${k.value/10})`,d.stroke();b()}function A(e){return/^[\u0590-\u05FF]$/.test(e)}function D(){const e=[],i=[{id:"blue",matrix:[[1,0,0],[1,1,1]],svgUrl:"images/blue_block.svg"},{id:"green",matrix:[[1,0],[1,1],[0,1]],svgUrl:"images/green_block.svg"},{id:"orange",matrix:[[0,0,1],[1,1,1]],svgUrl:"images/orange_block.svg"},{id:"pink",matrix:[[1,0],[1,1],[1,0]],svgUrl:"images/pink_block.svg"},{id:"red",matrix:[[0,1],[1,1],[1,0]],svgUrl:"images/red_block.svg"},{id:"turqoise",matrix:[[1,1,1,1]],svgUrl:"images/turqoise_block.svg"},{id:"yellow",matrix:[[1,1],[1,1]],svgUrl:"images/yellow_block.svg"}];return i.forEach(l=>{const n=document.getElementById(l.id);n&&n.checked&&e.push(l)}),e.length>0?e:i}function N(){return o.grid=Array.from(Array(o.gridHeight),()=>new Array(o.gridWidth).fill(0)),o.allowedAreas=Array.from(Array(o.gridHeight),()=>new Array(o.gridWidth).fill(1)),Promise.resolve()}function G(e,i,l){const n=new Image;n.src=e.svgUrl,n.onload=()=>{d.drawImage(n,i*o.blockWidth,l*o.blockWidth,o.blockWidth,o.blockWidth),b()}}function K(e,i,l){for(let n=0;n<e.matrix.length;n++)for(let t=0;t<e.matrix[n].length;t++)e.matrix[n][t]===1&&(o.grid[l+n][i+t]=1,o.allowedAreas[l+n][i+t]=0,G(e,i+t,l+n))}function Q(e,i,l){for(let n=0;n<4;n++){if(Z(e,i,l))return K(e,i,l),!0;e.matrix=ee(e.matrix)}return!1}function Z(e,i,l){for(let n=0;n<e.matrix.length;n++)for(let t=0;t<e.matrix[n].length;t++)if(e.matrix[n][t]===1){let a=l+n,r=i+t;if(r>=o.gridWidth||a>=o.gridHeight||r<0||a<0||o.grid[a][r]===1||o.allowedAreas[a][r]!==1)return!1}return!0}function J(e,i,l){const n=e.length,t=e[0].length,a=Math.floor(t/i),r=Math.floor(n/l),c=Array.from({length:l},()=>new Array(i).fill(0));for(let u=0;u<l;u++)for(let p=0;p<i;p++){let w=0,h=0;for(let g=0;g<r;g++)for(let s=0;s<a;s++)w+=e[u*r+g][p*a+s],h++;let m=w/h;c[u][p]=m>.1?1:0}return c}function X(e,i){return new Promise((l,n)=>{e!==""?opentype.load(i,function(t,a){if(t)alert("Font could not be loaded: "+t),n(t);else{const r=document.getElementById("canvas");r.style.display="block";const c=r.getContext("2d",{willReadFrequently:!0});c.clearRect(0,0,r.width,r.height);let u=600;const p=s=>{const y=a.getPath(e,0,0,s).getBoundingBox();return y.x2-y.x1<=r.width&&y.y2-y.y1<=r.height};for(;u>0&&!p(u);)u-=1;const w=a.getPath(e,0,0,u),h=w.getBoundingBox(),m=(r.width-(h.x2-h.x1))/2-h.x1,g=(r.height-(h.y2-h.y1))/2-h.y1;c.beginPath(),w.commands.forEach(function(s){s.type==="M"?c.moveTo(s.x+m,s.y+g):s.type==="L"?c.lineTo(s.x+m,s.y+g):s.type==="C"?c.bezierCurveTo(s.x1+m,s.y1+g,s.x2+m,s.y2+g,s.x+m,s.y+g):s.type==="Q"?c.quadraticCurveTo(s.x1+m,s.y1+g,s.x+m,s.y+g):s.type==="Z"&&c.closePath()}),c.fill(),setTimeout(()=>{const s=c.getImageData(0,0,r.width,r.height),I=[];for(let y=0;y<r.height;y++){let P=[];for(let L=0;L<r.width;L++){const S=(y*r.width+L)*4,R=s.data[S+3];P.push(R>128?1:0)}I.push(P)}r.style.display="none",o.allowedAreas=Y(J(I,o.gridWidth,o.gridHeight)),l()},500)}}):(o.allowedAreas=Array.from(Array(o.gridHeight),()=>new Array(o.gridWidth).fill(1)),l())})}function Y(e){const i=e.length,l=e[0].length;let n=-1;for(let r=i-1;r>=0;r--)if(e[r].some(c=>c===1)){n=r;break}const t=i-1-n,a=Array.from({length:i},()=>new Array(l).fill(0));for(let r=0;r<i;r++)r+t<i&&(a[r+t]=e[r]);return a}function x(){const e=v.value.trim(),i=E.value;let l=D();U().then(()=>F()).then(()=>N()).then(()=>X(e,i)).then(()=>{let n;do{n=!1;for(let t=0;t<o.gridHeight;t++)for(let a=0;a<o.gridWidth;a++)if(o.grid[t][a]===0&&o.allowedAreas[t][a]===1){const r=l[Math.floor(Math.random()*l.length)];Q({...r},a,t)&&(n=!0)}}while(n)}).catch(n=>{console.error("Failed to populate grid:",n)})}function ee(e){return e[0].map((i,l)=>e.map(n=>n[l]).reverse())}function te(){W.addEventListener("input",()=>{const e=v.value.trim();A(e)?x():U()}),T.addEventListener("input",b),H.addEventListener("input",b),O.addEventListener("input",b),k.addEventListener("input",F),v.addEventListener("input",()=>{const e=v.value.trim();A(e)?x():console.warn("Invalid input: Only a single Hebrew character is allowed.")}),E.addEventListener("input",x),q.addEventListener("click",function(){const e=document.createElement("canvas"),i=f.width/.1,l=f.height/.1;e.width=i,e.height=l,e.getContext("2d",{willReadFrequently:!0}).drawImage(f,0,0,i,l);const t=V.value,a=t==="jpeg"?"jpg":t,r=`image/${t}`;e.toBlob(function(c){let u=document.createElement("a");u.href=URL.createObjectURL(c),u.download=`grid-image.${a}`,u.click()},r)}),$.addEventListener("change",function(e){const i=e.target.files[0];if(i){const l=new FileReader;l.onload=function(n){const t=n.target.result;try{const a=opentype.parse(t),r=document.createElement("option");r.value=URL.createObjectURL(new Blob([t],{type:"font/ttf"})),r.text=i.name,E.add(r),E.value=r.value;const c=v.value.trim();A(c)?x():console.warn("Invalid input: Only a single Hebrew character is allowed.")}catch(a){alert("Font could not be parsed: "+a)}},l.onerror=function(n){alert("Error reading file: "+n)},l.readAsArrayBuffer(i)}else alert("No file selected")}),M.forEach(e=>{e.addEventListener("change",()=>{clearTimeout(o.repopulateTimeout),o.repopulateTimeout=setTimeout(()=>{const i=v.value.trim();A(i)&&x()},1e3)})}),_.addEventListener("click",()=>{C.style.display="none",B()}),z.addEventListener("click",()=>{C.style.display="block"})}document.addEventListener("DOMContentLoaded",function(){te(),B()});
